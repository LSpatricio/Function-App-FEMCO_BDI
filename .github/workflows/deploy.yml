# This workflow will build a .NET Core project and deploy it to an Azure Functions App on Windows or Linux when a commit is pushed to your default branch.
#
# This workflow assumes you have already created the target Azure Functions app.
# For instructions see https://learn.microsoft.com/en-us/azure/azure-functions/create-first-function-vs-code-csharp?tabs=in-process
#
# To configure this workflow:
# 1. Set up the following secrets in your repository:
#   - AZURE_FUNCTIONAPP_PUBLISH_PROFILE
# 2. Change env variables for your configuration.
#
# For more information on:
#   - GitHub Actions for Azure: https://github.com/Azure/Actions
#   - Azure Functions Action: https://github.com/Azure/functions-action
#   - Publish Profile: https://github.com/Azure/functions-action#using-publish-profile-as-deployment-credential-recommended
#   - Azure Service Principal for RBAC: https://github.com/Azure/functions-action#using-azure-service-principal-for-rbac-as-deployment-credential
#
# For more samples to get started with GitHub Action workflows to deploy to Azure: https://github.com/Azure/actions-workflow-samples/tree/master/FunctionApp

name: Deploy DotNet project to Azure Function App

on:
  #workflow_run:
   # workflows: [CI Azure Function]
    #types: [completed]
#  push:
 #   branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
    types: [closed]
    
  workflow_dispatch:
  
permissions:
  contents: read
  actions: read

env:
  AZURE_FUNCTIONAPP_NAME: ''   # set this to your function app name on Azure

jobs:
  deploy-dev:
    #if: ${{ github.event.workflow_run.conclusion == 'success' }}
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest # For Linux, use ubuntu-latest
    environment: DEV
   
    steps:
   # - name: obtain all files
    #  run: ls -la
    - uses: actions/checkout@1e31de5234b9f8995739874a8ce0492dc87873e2
    - name: Setup .NET
      uses: actions/setup-dotnet@dc30e5defeb4a0047e149c684eab597f5f37f67d
      with:
        dotnet-version: '6.0.x'
    - name: Build for deploy
      run: dotnet build --configuration Release --output ./output
      
   # - name : Obtaine artifact de ${{ github.repository }}
   #   uses:   actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 #V4  
   #  with:
   #     run-id: ${{ github.event.workflow_run.id }}  # ID del workflow que subi√≥ el artifact
   #     repository: ${{ github.repository }}  # Mismo repositorio
   #     github-token: ${{ secrets.GITHUB_TOKEN}}
   #     path: ./downloaded-artifact
   #     name: functionApp
        
    #- name: List downloaded files
    #  run: ls -la 
    - name: 'Run Azure Functions Action'
      uses: Azure/functions-action@0bd707f87c0b6385742bab336c74e1afc61f6369 #v1
      id: fa
      with:
        app-name: 'FEMCOBDIDEV'
        package: ./output
        slot-name: 'Production' 
        publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
  
  deploy-qa:
    needs: deploy-dev
    runs-on: ubuntu-latest # For Linux, use ubuntu-latest
    environment: QA
   
    steps:
    - uses: actions/checkout@1e31de5234b9f8995739874a8ce0492dc87873e2
    - name: Setup .NET
      uses: actions/setup-dotnet@dc30e5defeb4a0047e149c684eab597f5f37f67d
      with:
        dotnet-version: '6.0.x'
    - name: Build for deploy
      run: dotnet build --configuration Release --output ./output
 
    - name: 'Run Azure Functions Action'
      uses: Azure/functions-action@0bd707f87c0b6385742bab336c74e1afc61f6369 #v1
      id: fa
      with:
        app-name: 'FEMCOBDIQA'
        package: ./output
        slot-name: 'Production' 
        publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
    
  deploy-prd:
    needs: deploy-qa
    runs-on: ubuntu-latest # For Linux, use ubuntu-latest
    environment: PRD
   
    steps:
    - uses: actions/checkout@1e31de5234b9f8995739874a8ce0492dc87873e2
    - name: Setup .NET
      uses: actions/setup-dotnet@dc30e5defeb4a0047e149c684eab597f5f37f67d
      with:
        dotnet-version: '6.0.x'
    - name: Build for deploy
      run: dotnet build --configuration Release --output ./output
 
    - name: 'Run Azure Functions Action'
      uses: Azure/functions-action@0bd707f87c0b6385742bab336c74e1afc61f6369 #v1
      id: fa
      with:
        app-name: 'FEMCOBDIPRD'
        package: ./output
        slot-name: 'Production' 
        publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
  
    

        
